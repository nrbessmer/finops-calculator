<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinOps++</title>
  <!-- Import Google Font (Roboto Mono) for a techie look -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS for collapse and layout -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Custom CSS with muted background and enhanced headers -->
  <style>
    body { 
      background: #eaeaea; 
      font-family: 'Roboto Mono', monospace;
      color: #000;
      padding-bottom: 2rem;
    }
    p, li, label, input, button, textarea { 
      font-weight: 400; 
    }
    a { 
      color: #0000EE; 
      text-decoration: none; 
    }
    a:hover { text-decoration: underline; }
    .header {
      text-align: center;
      padding: 2.5rem 0;
      border-bottom: 3px solid #4a90e2;
      margin-bottom: 2rem;
    }
    .header h1 {
      font-size: 3.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
      font-weight: 700;
      background: linear-gradient(45deg, #4a90e2, #50e3c2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p {
      font-size: 1.2rem;
      color: #333;
    }
    .section-card { 
      margin-bottom: 1.5rem; 
      border: 1px solid #ccc;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .card-header { 
      background: linear-gradient(45deg, #4a90e2, #50e3c2);
      color: #fff; 
      cursor: pointer;
      user-select: none;
      text-transform: uppercase;
      font-weight: 700;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid #ccc;
      transition: background 0.3s ease;
    }
    .card-header:hover { 
      background: linear-gradient(45deg, #3b7cc4, #3ce0aa);
    }
    .card-body { 
      background: #fff; 
      color: #000;
      padding: 1rem 1.25rem;
    }
    .instruction { font-size: 0.9rem; margin-bottom: 1rem; }
    .form-control {
      background: #fff;
      border: 1px solid #ccc;
      color: #000;
    }
    .form-control:focus {
      background: #fff;
      border-color: #4a90e2;
      box-shadow: none;
      color: #000;
    }
    .btn {
      border: 1px solid #4a90e2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #4a90e2;
      color: #fff;
      margin-bottom: 1rem;
    }
    footer { 
      text-align: center; 
      padding: 1rem 0; 
      margin-top: 2rem; 
      background: #fff; 
      color: #000;
      border-top: 1px solid #ccc;
      font-size: 0.8rem;
      font-family: Courier, monospace;
    }
    .export-margin { margin-bottom: 12px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="container">
    <div class="header">
      <h1>FinOps++</h1>
      <p>Cost Modeling • Live Cloud Pricing • Forecasting • Simulation • Exportable Reports</p>
    </div>
  </div>
  
  <div class="container">
    <!-- [All the on-screen sections remain unchanged: Overview, Practical Use Cases, Variable Explanations, etc.] -->
    <!-- ... (Sections omitted for brevity; please include the sections as shown in previous versions) ... -->
    
    <!-- Export Report Section (Exported) -->
    <div class="card section-card">
      <div class="card-header" data-toggle="collapse" data-target="#exportSection" aria-expanded="true" aria-controls="exportSection">
        Export Report
      </div>
      <div id="exportSection" class="collapse show">
        <div class="card-body">
          <p class="instruction">Generate a PDF report including Deterministic Results, Forecast Chart, Monte Carlo Simulation Summary, Sensitivity Analysis, and User Notes. The report will display the current date.</p>
          <button id="exportReportBtn" class="btn btn-secondary">Export Report as PDF</button>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <footer>
      <p style="color: orange;">
        (c)(p) 2025 Tully EDM Vibe LLC All Rights Reserved.
        <br>
        WARNING: These calculations are estimates. Users should conduct further analysis and vet these results. All risk is the user's responsibility as this tool is educational in nature.
      </p>
    </footer>
  </div>
  
  <!-- Dependencies: jQuery, Bootstrap JS, Chart.js, jsPDF -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Persist inputs and textareas using localStorage
    function persistInputs() {
      const elements = document.querySelectorAll('input[type="number"], textarea');
      elements.forEach(el => {
        const stored = localStorage.getItem(el.id);
        if (stored !== null) {
          el.value = stored;
        }
        el.addEventListener('change', () => { 
          localStorage.setItem(el.id, el.value); 
        });
      });
    }
    window.addEventListener('DOMContentLoaded', persistInputs);
    
    // Helper: Compute Category Cost
    function computeCategoryCost(units, baseCost, tier1Threshold, tier1Rate, tier2Threshold, tier2Rate) {
      if (units <= tier1Threshold) {
        return units * baseCost;
      } else if (units <= tier2Threshold) {
        return tier1Threshold * baseCost + (units - tier1Threshold) * baseCost * (1 - tier1Rate / 100);
      } else {
        return tier1Threshold * baseCost +
               (tier2Threshold - tier1Threshold) * baseCost * (1 - tier1Rate / 100) +
               (units - tier2Threshold) * baseCost * (1 - tier2Rate / 100);
      }
    }
    
    // (All other on-screen calculation functions remain as in previous version.)
    
    // Export Report as PDF with multi-page logic
    async function exportReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setTextColor(0, 0, 0);
      let yPos = 15;
      const pageHeight = doc.internal.pageSize.getHeight();
      
      // Function to check and add new page if needed
      function checkPageBreak(additionalHeight) {
        if (yPos + additionalHeight > pageHeight - 20) {
          doc.addPage();
          yPos = 20;
        }
      }
      
      // Add current date at top
      const currentDate = new Date().toISOString().split("T")[0];
      doc.setFontSize(10);
      doc.text("Date: " + currentDate, 10, yPos);
      yPos += 8;
      
      // Title
      doc.setFontSize(16);
      doc.text("FinOps++ Analysis Report", 10, yPos);
      yPos += 10;
      
      // Deterministic Results Section
      doc.setFontSize(12);
      doc.text("Deterministic Results:", 10, yPos);
      yPos += 6;
      let detText = document.getElementById("deterministicResults").innerText;
      let detLines = doc.splitTextToSize(detText, 180);
      detLines.forEach(line => {
        checkPageBreak(6);
        doc.text(line, 10, yPos);
        yPos += 6;
      });
      yPos += 4;
      
      // Include Deterministic Pie Chart (if available)
      const pieCanvas = document.getElementById('pieChart');
      if (pieCanvas && pieCanvas.style.display !== 'none') {
        const pieImgData = pieCanvas.toDataURL("image/png");
        checkPageBreak(90);
        doc.text("Deterministic Pie Chart:", 10, yPos);
        yPos += 6;
        doc.addImage(pieImgData, 'PNG', 10, yPos, 180, 80);
        yPos += 80 + 4;
      }
      
      // Forecast Chart Section
      const forecastCanvas = document.getElementById('forecastChart');
      if (forecastCanvas && forecastCanvas.style.display !== 'none') {
        const forecastImgData = forecastCanvas.toDataURL("image/png");
        checkPageBreak(90);
        doc.text("12‑Month Forecast Chart:", 10, yPos);
        yPos += 6;
        doc.addImage(forecastImgData, 'PNG', 10, yPos, 180, 80);
        yPos += 80 + 4;
      }
      
      // Monte Carlo Simulation Summary Section
      doc.text("Monte Carlo Simulation Summary:", 10, yPos);
      yPos += 6;
      let simText = document.getElementById("simulationResults").innerText;
      let simLines = doc.splitTextToSize(simText, 180);
      simLines.forEach(line => {
        checkPageBreak(6);
        doc.text(line, 10, yPos);
        yPos += 6;
      });
      yPos += 4;
      
      // Include Monte Carlo Histogram Chart (if available)
      const histCanvas = document.getElementById('histogramChart');
      if (histCanvas && histCanvas.style.display !== 'none') {
        const histImgData = histCanvas.toDataURL("image/png");
        checkPageBreak(90);
        doc.text("Monte Carlo Histogram Chart:", 10, yPos);
        yPos += 6;
        doc.addImage(histImgData, 'PNG', 10, yPos, 180, 80);
        yPos += 80 + 4;
      }
      
      // Sensitivity Analysis Section
      doc.text("Sensitivity Analysis:", 10, yPos);
      yPos += 6;
      let sensText = document.getElementById("sensitivityResults").innerText;
      let sensLines = doc.splitTextToSize(sensText, 180);
      sensLines.forEach(line => {
        checkPageBreak(6);
        doc.text(line, 10, yPos);
        yPos += 6;
      });
      yPos += 4;
      
      // User Notes Section
      doc.text("User Notes:", 10, yPos);
      yPos += 6;
      let notes = document.getElementById("userNotes").value;
      let notesLines = doc.splitTextToSize(notes, 180);
      notesLines.forEach(line => {
        checkPageBreak(6);
        doc.text(line, 10, yPos);
        yPos += 6;
      });
      yPos += 4;
      
      doc.save("FinOps_Report.pdf");
    }
    document.getElementById('exportReportBtn').addEventListener('click', exportReport);
  </script>
</body>
</html>
