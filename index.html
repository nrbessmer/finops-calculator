<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinOps Xcalculator!</title>
  <!-- Bootstrap CSS for modern styling -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Custom CSS using Tahoma -->
  <style>
    body { 
      background: #121212; 
      font-family: Tahoma, sans-serif;
      color: #e0e0e0;
    }
    /* Header styling */
    .header {
      background: #222;
      color: #f5f5f5;
      padding: 3rem 0;
      text-align: center;
      border-bottom: 3px solid #0d6efd;
    }
    .header h1 {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .header p {
      font-size: 1.2rem;
      margin: 0;
      color: #ccc;
    }
    /* Card styling */
    .section-card { 
      margin-bottom: 2rem; 
      border: 1px solid #333;
      background: #1e1e1e;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .card-header { 
      background-color: #0d6efd; 
      color: #ffffff; 
      text-transform: uppercase;
      font-weight: bold;
      border-bottom: 1px solid #333;
    }
    .card-body {
      background: #1e1e1e;
    }
    .instruction { 
      font-size: 0.9rem; 
      color: #bbb; 
      margin-bottom: 1rem; 
    }
    .form-control {
      background: #2c2c2c;
      border: 1px solid #555;
      color: #e0e0e0;
    }
    .form-control:focus {
      background: #2c2c2c;
      border-color: #0d6efd;
      box-shadow: none;
      color: #fff;
    }
    .btn {
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    footer { 
      text-align: center; 
      padding: 1rem 0; 
      margin-top: 2rem; 
      background: #1e1e1e; 
      color: #aaa;
      border-top: 1px solid #333;
    }
    a { color: #0d6efd; }
  </style>
</head>
<body>
  <!-- Updated Header -->
  <div class="header">
    <h1>FinOps Xcalculator!</h1>
    <p>Cost Modeling • Live Cloud Pricing • Forecasting • Simulation • Exportable Reports</p>
  </div>

  <div class="container">
    <!-- Variable Explanations Section -->
    <div class="card section-card">
      <div class="card-header">Variable Explanations</div>
      <div class="card-body">
        <ul>
          <!-- Overall & Revenue -->
          <li><strong>Overall Fixed Cost ($):</strong> Base fixed expenses independent of usage.</li>
          <li><strong>Base Revenue per Unit ($):</strong> Revenue earned from each unit sold or used at the base rate.</li>
          <li><strong>Revenue Units:</strong> The total number of units sold or utilized.</li>
          <li><strong>Elasticity Threshold (Revenue Units):</strong> The usage threshold beyond which revenue per unit starts to decrease.</li>
          <li><strong>Elasticity Factor:</strong> The decrement in revenue per unit for every additional unit beyond the threshold.</li>

          <!-- Cost Categories: Compute, Storage, Network, License -->
          <li><strong>Fixed Cost (per category):</strong> The constant expense for the service (e.g., server base cost).</li>
          <li><strong>Variable Cost per Unit:</strong> The cost incurred per unit of service usage.</li>
          <li><strong>Units:</strong> The measure of usage (e.g., compute hours, GB, seats).</li>
          <li><strong>Tier 1 Threshold:</strong> The usage limit at which the first discount rate applies.</li>
          <li><strong>Tier 1 Discount Rate (%):</strong> The percentage discount for usage exceeding the Tier 1 threshold.</li>
          <li><strong>Tier 2 Threshold:</strong> The usage limit at which a higher discount rate applies.</li>
          <li><strong>Tier 2 Discount Rate (%):</strong> The percentage discount for usage exceeding the Tier 2 threshold.</li>

          <!-- Forecasting and Simulation -->
          <li><strong>Monthly Growth Rate (%):</strong> The expected monthly percentage increase in revenue and costs.</li>
          <li><strong>Simulation Iterations:</strong> The number of runs for Monte Carlo simulation to model uncertainty.</li>
          <li><strong>Cost Variability (%):</strong> The expected percentage fluctuation in cost estimates.</li>
          <li><strong>Revenue Variability (%):</strong> The expected percentage fluctuation in revenue estimates.</li>

          <!-- Cloud Pricing Integration -->
          <li><strong>Live Cloud Pricing:</strong> This section fetches live compute cost data from AWS, Azure, and GCP to update your cost assumptions.</li>
        </ul>
      </div>
    </div>

    <!-- Overall & Revenue Inputs Section -->
    <div class="card section-card">
      <div class="card-header">Overall & Revenue Inputs</div>
      <div class="card-body">
        <p class="instruction">
          Enter your overall fixed cost and revenue assumptions. These values form the foundation of your analysis.
        </p>
        <div class="form-group">
          <label for="overallFixedCost">Overall Fixed Cost ($):</label>
          <input type="number" id="overallFixedCost" class="form-control" value="1000" step="any">
        </div>
        <h5>Revenue Inputs</h5>
        <p class="instruction">
          Provide your base revenue per unit and total revenue units. An elasticity factor will adjust your revenue per unit if usage exceeds the threshold.
        </p>
        <div class="form-group">
          <label for="revenuePerUnit">Base Revenue per Unit ($):</label>
          <input type="number" id="revenuePerUnit" class="form-control" value="25" step="any">
        </div>
        <div class="form-group">
          <label for="revenueUnits">Revenue Units:</label>
          <input type="number" id="revenueUnits" class="form-control" value="1000" step="any">
        </div>
        <div class="form-group">
          <label for="elasticityThresholdRev">Elasticity Threshold (Revenue Units):</label>
          <input type="number" id="elasticityThresholdRev" class="form-control" value="800" step="any">
        </div>
        <div class="form-group">
          <label for="elasticityFactorRev">Elasticity Factor (Revenue $ drop per unit beyond threshold):</label>
          <input type="number" id="elasticityFactorRev" class="form-control" value="0.03" step="any">
        </div>
      </div>
    </div>

    <!-- Cost Categories Section -->
    <div class="card section-card">
      <div class="card-header">Cost Categories</div>
      <div class="card-body">
        <p class="instruction">
          Input your costs for each category. Each category uses a tiered discount model so that higher usage reduces the effective cost per unit.
        </p>
        <!-- Compute Category -->
        <div class="card mb-3">
          <div class="card-header">Compute</div>
          <div class="card-body">
            <p class="instruction">Enter your compute costs (e.g., server hours). Tiered discounting applies based on usage thresholds.</p>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="computeFixed">Fixed Cost ($):</label>
                <input type="number" id="computeFixed" class="form-control" value="500" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="computeVariable">Variable Cost per Unit ($):</label>
                <input type="number" id="computeVariable" class="form-control" value="0.15" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="computeUnits">Units (e.g., compute hours):</label>
                <input type="number" id="computeUnits" class="form-control" value="6000" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="computeTier1Threshold">Tier 1 Threshold:</label>
                <input type="number" id="computeTier1Threshold" class="form-control" value="4000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="computeTier1Rate">Tier 1 Discount Rate (%):</label>
                <input type="number" id="computeTier1Rate" class="form-control" value="5" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="computeTier2Threshold">Tier 2 Threshold:</label>
                <input type="number" id="computeTier2Threshold" class="form-control" value="8000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="computeTier2Rate">Tier 2 Discount Rate (%):</label>
                <input type="number" id="computeTier2Rate" class="form-control" value="10" step="any">
              </div>
            </div>
          </div>
        </div>
        <!-- Storage Category -->
        <div class="card mb-3">
          <div class="card-header">Storage</div>
          <div class="card-body">
            <p class="instruction">Enter your storage costs (e.g., GB used). This section also uses tiered discounting.</p>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="storageFixed">Fixed Cost ($):</label>
                <input type="number" id="storageFixed" class="form-control" value="300" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="storageVariable">Variable Cost per Unit ($):</label>
                <input type="number" id="storageVariable" class="form-control" value="0.05" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="storageUnits">Units (e.g., GB):</label>
                <input type="number" id="storageUnits" class="form-control" value="20000" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="storageTier1Threshold">Tier 1 Threshold:</label>
                <input type="number" id="storageTier1Threshold" class="form-control" value="15000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="storageTier1Rate">Tier 1 Discount Rate (%):</label>
                <input type="number" id="storageTier1Rate" class="form-control" value="3" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="storageTier2Threshold">Tier 2 Threshold:</label>
                <input type="number" id="storageTier2Threshold" class="form-control" value="30000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="storageTier2Rate">Tier 2 Discount Rate (%):</label>
                <input type="number" id="storageTier2Rate" class="form-control" value="7" step="any">
              </div>
            </div>
          </div>
        </div>
        <!-- Network Category -->
        <div class="card mb-3">
          <div class="card-header">Network</div>
          <div class="card-body">
            <p class="instruction">Enter your network costs (e.g., data transferred in GB). Discounts apply based on usage thresholds.</p>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="networkFixed">Fixed Cost ($):</label>
                <input type="number" id="networkFixed" class="form-control" value="200" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="networkVariable">Variable Cost per Unit ($):</label>
                <input type="number" id="networkVariable" class="form-control" value="0.10" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="networkUnits">Units (e.g., GB transferred):</label>
                <input type="number" id="networkUnits" class="form-control" value="10000" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="networkTier1Threshold">Tier 1 Threshold:</label>
                <input type="number" id="networkTier1Threshold" class="form-control" value="8000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="networkTier1Rate">Tier 1 Discount Rate (%):</label>
                <input type="number" id="networkTier1Rate" class="form-control" value="4" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="networkTier2Threshold">Tier 2 Threshold:</label>
                <input type="number" id="networkTier2Threshold" class="form-control" value="15000" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="networkTier2Rate">Tier 2 Discount Rate (%):</label>
                <input type="number" id="networkTier2Rate" class="form-control" value="8" step="any">
              </div>
            </div>
          </div>
        </div>
        <!-- License Category -->
        <div class="card mb-3">
          <div class="card-header">License</div>
          <div class="card-body">
            <p class="instruction">Enter your licensing costs (e.g., software seats). Discounts may apply when purchasing in volume.</p>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="licenseFixed">Fixed Cost ($):</label>
                <input type="number" id="licenseFixed" class="form-control" value="400" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="licenseVariable">Variable Cost per Unit ($):</label>
                <input type="number" id="licenseVariable" class="form-control" value="1.00" step="any">
              </div>
              <div class="form-group col-md-4">
                <label for="licenseUnits">Units (e.g., seats):</label>
                <input type="number" id="licenseUnits" class="form-control" value="300" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="licenseTier1Threshold">Tier 1 Threshold:</label>
                <input type="number" id="licenseTier1Threshold" class="form-control" value="250" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="licenseTier1Rate">Tier 1 Discount Rate (%):</label>
                <input type="number" id="licenseTier1Rate" class="form-control" value="10" step="any">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="licenseTier2Threshold">Tier 2 Threshold:</label>
                <input type="number" id="licenseTier2Threshold" class="form-control" value="500" step="any">
              </div>
              <div class="form-group col-md-6">
                <label for="licenseTier2Rate">Tier 2 Discount Rate (%):</label>
                <input type="number" id="licenseTier2Rate" class="form-control" value="15" step="any">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cloud Pricing Integration Section -->
    <div class="card section-card">
      <div class="card-header">Cloud Pricing Integration (Live)</div>
      <div class="card-body">
        <p class="instruction">
          Click the button below to fetch the latest live compute cost data from AWS, Azure, and Google Cloud. This data updates your cost assumptions in real time.
        </p>
        <button id="fetchCloudPrices" class="btn btn-primary mb-3">Fetch Latest Cloud Prices</button>
        <div id="cloudPricingResults" class="result" style="display:none;"></div>
      </div>
    </div>

    <!-- Forecasting Section -->
    <div class="card section-card">
      <div class="card-header">Forecasting (12‑Month Projection)</div>
      <div class="card-body">
        <p class="instruction">
          Enter your monthly growth rate to project revenue, cost, and profit over the next 12 months.
        </p>
        <div class="form-group">
          <label for="monthlyGrowth">Monthly Growth Rate (%):</label>
          <input type="number" id="monthlyGrowth" class="form-control" value="5" step="any">
        </div>
        <button id="runForecast" class="btn btn-success mb-3">Run Forecast</button>
        <canvas id="forecastChart" width="600" height="300" style="display:none;"></canvas>
      </div>
    </div>

    <!-- Deterministic Calculation Section -->
    <div class="card section-card">
      <div class="card-header">Deterministic Calculation & Results</div>
      <div class="card-body">
        <p class="instruction">
          Click the button below to calculate deterministic metrics (total revenue, cost, profit, ROI) and view a detailed cost breakdown.
        </p>
        <button id="calculateBtn" class="btn btn-warning mb-3">Calculate Deterministic Metrics</button>
        <div id="deterministicResults" class="result" style="display:none;"></div>
        <canvas id="pieChart" width="400" height="200" style="display:none;"></canvas>
      </div>
    </div>

    <!-- Monte Carlo Simulation Section -->
    <div class="card section-card">
      <div class="card-header">Monte Carlo Simulation</div>
      <div class="card-body">
        <p class="instruction">
          Use this section to simulate uncertainty in your cost and revenue estimates. Adjust the variability percentages and number of iterations to model risk.
        </p>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="simIterations">Simulation Iterations:</label>
            <input type="number" id="simIterations" class="form-control" value="1000" step="1">
          </div>
          <div class="form-group col-md-4">
            <label for="costVariability">Cost Variability (%):</label>
            <input type="number" id="costVariability" class="form-control" value="10" step="any">
          </div>
          <div class="form-group col-md-4">
            <label for="revenueVariability">Revenue Variability (%):</label>
            <input type="number" id="revenueVariability" class="form-control" value="10" step="any">
          </div>
        </div>
        <button id="runSimulation" class="btn btn-danger mb-3">Run Simulation</button>
        <div id="simulationResults" class="result" style="display:none;"></div>
        <canvas id="histogramChart" width="600" height="300" style="display:none;"></canvas>
      </div>
    </div>

    <!-- Sensitivity Analysis Section -->
    <div class="card section-card">
      <div class="card-header">Sensitivity Analysis</div>
      <div class="card-body">
        <p class="instruction">
          Examine how varying the Compute Tier 1 discount rate affects overall profit. This analysis helps identify the most sensitive parameters.
        </p>
        <button id="runSensitivity" class="btn btn-info mb-3">Run Sensitivity Analysis</button>
        <div id="sensitivityResults" class="result" style="display:none;"></div>
      </div>
    </div>

    <!-- Export Report Section -->
    <div class="card section-card">
      <div class="card-header">Export Report</div>
      <div class="card-body">
        <p class="instruction">
          Generate a professional PDF report summarizing your analysis, including key metrics and charts, for sharing with your team.
        </p>
        <button id="exportReportBtn" class="btn btn-secondary">Export Report as PDF</button>
      </div>
    </div>

    <!-- Footer with Contact Info -->
    <footer>
      <p>For further inquiries, please reach out to <a href="mailto:info@tullyedmvibe.com">info@tullyedmvibe.com</a></p>
    </footer>
  </div>

  <!-- Dependencies: jQuery, Bootstrap JS, Chart.js, jsPDF -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ---------- Persistence: Save inputs to localStorage ----------
    function persistInputs() {
      const inputs = document.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        const stored = localStorage.getItem(input.id);
        if (stored !== null) { input.value = stored; }
        input.addEventListener('change', () => { localStorage.setItem(input.id, input.value); });
      });
    }
    window.addEventListener('DOMContentLoaded', persistInputs);

    // ---------- Cloud Pricing Integration ----------
    async function fetchAWSPrices() {
      try {
        const response = await fetch('https://pricing.us-east-1.amazonaws.com/offers/v1.0/aws/AmazonEC2/current/index.json');
        const data = await response.json();
        return { compute: 0.13 }; // Dummy extraction for demo purposes
      } catch (error) {
        console.error("AWS Pricing fetch error:", error);
        return { compute: 0.15 };
      }
    }
    async function fetchAzurePrices() {
      try {
        const response = await fetch('https://prices.azure.com/api/retail/prices');
        const data = await response.json();
        return { compute: 0.14 };
      } catch (error) {
        console.error("Azure Pricing fetch error:", error);
        return { compute: 0.16 };
      }
    }
    async function fetchGCPPrices() {
      try {
        const response = await fetch('https://cloudpricingcalculator.appspot.com/static/data/pricelist.json');
        const data = await response.json();
        return { compute: data.gcp.compute ? data.gcp.compute : 0.12 };
      } catch (error) {
        console.error("GCP Pricing fetch error:", error);
        return { compute: 0.11 };
      }
    }
    document.getElementById('fetchCloudPrices').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('cloudPricingResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<p>Fetching latest cloud pricing…</p>';
      try {
        const [aws, azure, gcp] = await Promise.all([fetchAWSPrices(), fetchAzurePrices(), fetchGCPPrices()]);
        let html = '<h5>Latest Cloud Prices:</h5><table class="table table-bordered"><thead><tr><th>Provider</th><th>Compute ($/unit)</th></tr></thead><tbody>';
        html += `<tr><td>AWS</td><td>${aws.compute}</td></tr>`;
        html += `<tr><td>Azure</td><td>${azure.compute}</td></tr>`;
        html += `<tr><td>Google Cloud</td><td>${gcp.compute}</td></tr>`;
        html += '</tbody></table>';
        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = '<p>Error fetching cloud pricing data.</p>';
      }
    });

    // ---------- Helper: Compute Category Cost with Tiered Discounts ----------
    function computeCategoryCost(units, baseCost, tier1Threshold, tier1Rate, tier2Threshold, tier2Rate) {
      let cost = 0;
      if (units <= tier1Threshold) {
        cost = units * baseCost;
      } else if (units <= tier2Threshold) {
        cost = tier1Threshold * baseCost + (units - tier1Threshold) * baseCost * (1 - tier1Rate/100);
      } else {
        cost = tier1Threshold * baseCost +
               (tier2Threshold - tier1Threshold) * baseCost * (1 - tier1Rate/100) +
               (units - tier2Threshold) * baseCost * (1 - tier2Rate/100);
      }
      return cost;
    }

    // ---------- Deterministic Calculation ----------
    document.getElementById('calculateBtn').addEventListener('click', () => {
      const overallFixedCost = parseFloat(document.getElementById('overallFixedCost').value);
      const revenuePerUnit = parseFloat(document.getElementById('revenuePerUnit').value);
      const revenueUnits = parseFloat(document.getElementById('revenueUnits').value);
      const elasticityThresholdRev = parseFloat(document.getElementById('elasticityThresholdRev').value);
      const elasticityFactorRev = parseFloat(document.getElementById('elasticityFactorRev').value);
      let effectiveRevenuePerUnit = revenuePerUnit;
      if (revenueUnits > elasticityThresholdRev) {
        effectiveRevenuePerUnit = Math.max(revenuePerUnit - elasticityFactorRev * (revenueUnits - elasticityThresholdRev), 0);
      }
      const totalRevenue = revenueUnits * effectiveRevenuePerUnit;

      const computeFixed = parseFloat(document.getElementById('computeFixed').value);
      const computeVariable = parseFloat(document.getElementById('computeVariable').value);
      const computeUnits = parseFloat(document.getElementById('computeUnits').value);
      const computeTier1Threshold = parseFloat(document.getElementById('computeTier1Threshold').value);
      const computeTier1Rate = parseFloat(document.getElementById('computeTier1Rate').value);
      const computeTier2Threshold = parseFloat(document.getElementById('computeTier2Threshold').value);
      const computeTier2Rate = parseFloat(document.getElementById('computeTier2Rate').value);
      const computeCost = computeFixed + computeCategoryCost(computeUnits, computeVariable, computeTier1Threshold, computeTier1Rate, computeTier2Threshold, computeTier2Rate);

      const storageFixed = parseFloat(document.getElementById('storageFixed').value);
      const storageVariable = parseFloat(document.getElementById('storageVariable').value);
      const storageUnits = parseFloat(document.getElementById('storageUnits').value);
      const storageTier1Threshold = parseFloat(document.getElementById('storageTier1Threshold').value);
      const storageTier1Rate = parseFloat(document.getElementById('storageTier1Rate').value);
      const storageTier2Threshold = parseFloat(document.getElementById('storageTier2Threshold').value);
      const storageTier2Rate = parseFloat(document.getElementById('storageTier2Rate').value);
      const storageCost = storageFixed + computeCategoryCost(storageUnits, storageVariable, storageTier1Threshold, storageTier1Rate, storageTier2Threshold, storageTier2Rate);

      const networkFixed = parseFloat(document.getElementById('networkFixed').value);
      const networkVariable = parseFloat(document.getElementById('networkVariable').value);
      const networkUnits = parseFloat(document.getElementById('networkUnits').value);
      const networkTier1Threshold = parseFloat(document.getElementById('networkTier1Threshold').value);
      const networkTier1Rate = parseFloat(document.getElementById('networkTier1Rate').value);
      const networkTier2Threshold = parseFloat(document.getElementById('networkTier2Threshold').value);
      const networkTier2Rate = parseFloat(document.getElementById('networkTier2Rate').value);
      const networkCost = networkFixed + computeCategoryCost(networkUnits, networkVariable, networkTier1Threshold, networkTier1Rate, networkTier2Threshold, networkTier2Rate);

      const licenseFixed = parseFloat(document.getElementById('licenseFixed').value);
      const licenseVariable = parseFloat(document.getElementById('licenseVariable').value);
      const licenseUnits = parseFloat(document.getElementById('licenseUnits').value);
      const licenseTier1Threshold = parseFloat(document.getElementById('licenseTier1Threshold').value);
      const licenseTier1Rate = parseFloat(document.getElementById('licenseTier1Rate').value);
      const licenseTier2Threshold = parseFloat(document.getElementById('licenseTier2Threshold').value);
      const licenseTier2Rate = parseFloat(document.getElementById('licenseTier2Rate').value);
      const licenseCost = licenseFixed + computeCategoryCost(licenseUnits, licenseVariable, licenseTier1Threshold, licenseTier1Rate, licenseTier2Threshold, licenseTier2Rate);

      const totalCost = overallFixedCost + computeCost + storageCost + networkCost + licenseCost;
      const profit = totalRevenue - totalCost;
      const profitMargin = totalRevenue ? (profit / totalRevenue * 100).toFixed(2) : "N/A";
      const roi = totalCost ? (profit / totalCost * 100).toFixed(2) : "N/A";

      const resultsDiv = document.getElementById('deterministicResults');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = `
        <h5>Deterministic Results</h5>
        <p><strong>Total Revenue:</strong> $${totalRevenue.toFixed(2)}</p>
        <p><strong>Total Cost:</strong> $${totalCost.toFixed(2)}</p>
        <p><strong>Profit:</strong> $${profit.toFixed(2)}</p>
        <p><strong>Profit Margin:</strong> ${profitMargin}%</p>
        <p><strong>ROI:</strong> ${roi}%</p>
        <h6>Cost Breakdown:</h6>
        <p>Compute: $${computeCost.toFixed(2)}, Storage: $${storageCost.toFixed(2)}, Network: $${networkCost.toFixed(2)}, License: $${licenseCost.toFixed(2)}</p>
      `;

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      document.getElementById('pieChart').style.display = 'block';
      if (window.myPieChart) window.myPieChart.destroy();
      window.myPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: ['Compute', 'Storage', 'Network', 'License'],
          datasets: [{
            data: [computeCost, storageCost, networkCost, licenseCost],
            backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)']
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    });

    // ---------- Forecasting (12‑Month Projection) ----------
    document.getElementById('runForecast').addEventListener('click', () => {
      const months = 12;
      const monthlyGrowth = parseFloat(document.getElementById('monthlyGrowth').value) / 100;
      const overallFixedCost = parseFloat(document.getElementById('overallFixedCost').value);
      const revenuePerUnit = parseFloat(document.getElementById('revenuePerUnit').value);
      const revenueUnits = parseFloat(document.getElementById('revenueUnits').value);
      const elasticityThresholdRev = parseFloat(document.getElementById('elasticityThresholdRev').value);
      const elasticityFactorRev = parseFloat(document.getElementById('elasticityFactorRev').value);

      function getBaselineCost(idPrefix) {
        const fixed = parseFloat(document.getElementById(idPrefix + 'Fixed').value);
        const variable = parseFloat(document.getElementById(idPrefix + 'Variable').value);
        const units = parseFloat(document.getElementById(idPrefix + 'Units').value);
        const tier1Threshold = parseFloat(document.getElementById(idPrefix + 'Tier1Threshold').value);
        const tier1Rate = parseFloat(document.getElementById(idPrefix + 'Tier1Rate').value);
        const tier2Threshold = parseFloat(document.getElementById(idPrefix + 'Tier2Threshold').value);
        const tier2Rate = parseFloat(document.getElementById(idPrefix + 'Tier2Rate').value);
        return fixed + computeCategoryCost(units, variable, tier1Threshold, tier1Rate, tier2Threshold, tier2Rate);
      }
      const computeCostBase = getBaselineCost('compute');
      const storageCostBase = getBaselineCost('storage');
      const networkCostBase = getBaselineCost('network');
      const licenseCostBase = getBaselineCost('license');
      const overallCostBase = overallFixedCost + computeCostBase + storageCostBase + networkCostBase + licenseCostBase;

      let forecastMonths = [];
      let forecastRevenue = [];
      let forecastCost = [];
      let forecastProfit = [];

      let currentRevenueUnits = revenueUnits;
      let currentOverallCost = overallCostBase;
      for (let m = 0; m <= months; m++) {
        let effectiveRevenuePerUnit = revenuePerUnit;
        if (currentRevenueUnits > elasticityThresholdRev) {
          effectiveRevenuePerUnit = Math.max(revenuePerUnit - elasticityFactorRev * (currentRevenueUnits - elasticityThresholdRev), 0);
        }
        const totalRev = currentRevenueUnits * effectiveRevenuePerUnit;
        forecastMonths.push("Month " + m);
        forecastRevenue.push(totalRev);
        forecastCost.push(currentOverallCost);
        forecastProfit.push(totalRev - currentOverallCost);

        currentRevenueUnits *= (1 + monthlyGrowth);
        currentOverallCost *= (1 + monthlyGrowth);
      }

      const forecastCtx = document.getElementById('forecastChart').getContext('2d');
      document.getElementById('forecastChart').style.display = 'block';
      if (window.myForecastChart) window.myForecastChart.destroy();
      window.myForecastChart = new Chart(forecastCtx, {
        type: 'line',
        data: {
          labels: forecastMonths,
          datasets: [
            { label: 'Revenue', data: forecastRevenue, borderColor: 'rgba(75, 192, 192, 1)', fill: false },
            { label: 'Cost', data: forecastCost, borderColor: 'rgba(255, 99, 132, 1)', fill: false },
            { label: 'Profit', data: forecastProfit, borderColor: 'rgba(54, 162, 235, 1)', fill: false }
          ]
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    });

    // ---------- Monte Carlo Simulation ----------
    document.getElementById('runSimulation').addEventListener('click', () => {
      const simIterations = parseInt(document.getElementById('simIterations').value);
      const costVariability = parseFloat(document.getElementById('costVariability').value) / 100;
      const revenueVariability = parseFloat(document.getElementById('revenueVariability').value) / 100;
      const revenuePerUnit = parseFloat(document.getElementById('revenuePerUnit').value);
      const revenueUnits = parseFloat(document.getElementById('revenueUnits').value);
      const elasticityThresholdRev = parseFloat(document.getElementById('elasticityThresholdRev').value);
      const elasticityFactorRev = parseFloat(document.getElementById('elasticityFactorRev').value);
      const overallFixedCost = parseFloat(document.getElementById('overallFixedCost').value);

      function getCategoryInputs(idPrefix) {
        return {
          fixed: parseFloat(document.getElementById(idPrefix + 'Fixed').value),
          variable: parseFloat(document.getElementById(idPrefix + 'Variable').value),
          units: parseFloat(document.getElementById(idPrefix + 'Units').value),
          tier1Threshold: parseFloat(document.getElementById(idPrefix + 'Tier1Threshold').value),
          tier1Rate: parseFloat(document.getElementById(idPrefix + 'Tier1Rate').value),
          tier2Threshold: parseFloat(document.getElementById(idPrefix + 'Tier2Threshold').value),
          tier2Rate: parseFloat(document.getElementById(idPrefix + 'Tier2Rate').value)
        };
      }
      const computeInputs = getCategoryInputs('compute');
      const storageInputs = getCategoryInputs('storage');
      const networkInputs = getCategoryInputs('network');
      const licenseInputs = getCategoryInputs('license');

      function getRandomNormal() {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
      }

      const simulationProfits = [];
      for (let i = 0; i < simIterations; i++) {
        const costMultiplier = 1 + getRandomNormal() * costVariability;
        const revenueMultiplier = 1 + getRandomNormal() * revenueVariability;

        const simComputeCost = computeInputs.fixed + computeCategoryCost(computeInputs.units, computeInputs.variable * costMultiplier, computeInputs.tier1Threshold, computeInputs.tier1Rate, computeInputs.tier2Threshold, computeInputs.tier2Rate);
        const simStorageCost = storageInputs.fixed + computeCategoryCost(storageInputs.units, storageInputs.variable * costMultiplier, storageInputs.tier1Threshold, storageInputs.tier1Rate, storageInputs.tier2Threshold, storageInputs.tier2Rate);
        const simNetworkCost = networkInputs.fixed + computeCategoryCost(networkInputs.units, networkInputs.variable * costMultiplier, networkInputs.tier1Threshold, networkInputs.tier1Rate, networkInputs.tier2Threshold, networkInputs.tier2Rate);
        const simLicenseCost = licenseInputs.fixed + computeCategoryCost(licenseInputs.units, licenseInputs.variable * costMultiplier, licenseInputs.tier1Threshold, licenseInputs.tier1Rate, licenseInputs.tier2Threshold, licenseInputs.tier2Rate);
        const totalSimCost = overallFixedCost + simComputeCost + simStorageCost + simNetworkCost + simLicenseCost;

        let simEffectiveRevenue = revenuePerUnit * revenueMultiplier;
        if (revenueUnits > elasticityThresholdRev) {
          simEffectiveRevenue = Math.max(revenuePerUnit * revenueMultiplier - elasticityFactorRev * (revenueUnits - elasticityThresholdRev), 0);
        }
        const totalSimRevenue = revenueUnits * simEffectiveRevenue;
        simulationProfits.push(totalSimRevenue - totalSimCost);
      }

      const sumProfit = simulationProfits.reduce((a, b) => a + b, 0);
      const avgProfit = sumProfit / simulationProfits.length;
      const minProfit = Math.min(...simulationProfits);
      const maxProfit = Math.max(...simulationProfits);
      const stdProfit = Math.sqrt(simulationProfits.reduce((a, b) => a + Math.pow(b - avgProfit, 2), 0) / simulationProfits.length);

      const numBins = 10;
      const profitRange = maxProfit - minProfit;
      const binSize = profitRange / numBins;
      const bins = new Array(numBins).fill(0);
      const binLabels = [];
      simulationProfits.forEach(profit => {
        let binIndex = Math.floor((profit - minProfit) / binSize);
        if (binIndex === numBins) binIndex = numBins - 1;
        bins[binIndex]++;
      });
      for (let i = 0; i < numBins; i++) {
        const binCenter = minProfit + binSize * (i + 0.5);
        binLabels.push(binCenter.toFixed(2));
      }

      const simResultsDiv = document.getElementById('simulationResults');
      simResultsDiv.style.display = 'block';
      simResultsDiv.innerHTML = `
        <h5>Simulation Summary (over ${simIterations} iterations):</h5>
        <p>Average Profit: $${avgProfit.toFixed(2)}</p>
        <p>Minimum Profit: $${minProfit.toFixed(2)}</p>
        <p>Maximum Profit: $${maxProfit.toFixed(2)}</p>
        <p>Standard Deviation: $${stdProfit.toFixed(2)}</p>
      `;

      const histCtx = document.getElementById('histogramChart').getContext('2d');
      document.getElementById('histogramChart').style.display = 'block';
      if (window.myHistChart) window.myHistChart.destroy();
      window.myHistChart = new Chart(histCtx, {
        type: 'bar',
        data: {
          labels: binLabels,
          datasets: [{
            label: 'Profit Frequency',
            data: bins,
            backgroundColor: 'rgba(153, 102, 255, 0.6)'
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    });

    // ---------- Sensitivity Analysis ----------
    document.getElementById('runSensitivity').addEventListener('click', () => {
      const baseRate = parseFloat(document.getElementById('computeTier1Rate').value);
      const sensitivityData = [];
      const sensitivityLabels = [];
      for (let delta = -5; delta <= 5; delta += 1) {
        const testRate = baseRate + delta;
        const computeFixed = parseFloat(document.getElementById('computeFixed').value);
        const computeVariable = parseFloat(document.getElementById('computeVariable').value);
        const computeUnits = parseFloat(document.getElementById('computeUnits').value);
        const computeTier1Threshold = parseFloat(document.getElementById('computeTier1Threshold').value);
        const computeTier2Threshold = parseFloat(document.getElementById('computeTier2Threshold').value);
        const computeTier2Rate = parseFloat(document.getElementById('computeTier2Rate').value);
        const modifiedComputeCost = computeFixed + computeCategoryCost(computeUnits, computeVariable, computeTier1Threshold, testRate, computeTier2Threshold, computeTier2Rate);

        const overallFixedCost = parseFloat(document.getElementById('overallFixedCost').value);
        const storageCost = parseFloat(document.getElementById('storageFixed').value) + computeCategoryCost(
          parseFloat(document.getElementById('storageUnits').value),
          parseFloat(document.getElementById('storageVariable').value),
          parseFloat(document.getElementById('storageTier1Threshold').value),
          parseFloat(document.getElementById('storageTier1Rate').value),
          parseFloat(document.getElementById('storageTier2Threshold').value),
          parseFloat(document.getElementById('storageTier2Rate').value)
        );
        const networkCost = parseFloat(document.getElementById('networkFixed').value) + computeCategoryCost(
          parseFloat(document.getElementById('networkUnits').value),
          parseFloat(document.getElementById('networkVariable').value),
          parseFloat(document.getElementById('networkTier1Threshold').value),
          parseFloat(document.getElementById('networkTier1Rate').value),
          parseFloat(document.getElementById('networkTier2Threshold').value),
          parseFloat(document.getElementById('networkTier2Rate').value)
        );
        const licenseCost = parseFloat(document.getElementById('licenseFixed').value) + computeCategoryCost(
          parseFloat(document.getElementById('licenseUnits').value),
          parseFloat(document.getElementById('licenseVariable').value),
          parseFloat(document.getElementById('licenseTier1Threshold').value),
          parseFloat(document.getElementById('licenseTier1Rate').value),
          parseFloat(document.getElementById('licenseTier2Threshold').value),
          parseFloat(document.getElementById('licenseTier2Rate').value)
        );

        const revenuePerUnit = parseFloat(document.getElementById('revenuePerUnit').value);
        const revenueUnits = parseFloat(document.getElementById('revenueUnits').value);
        const elasticityThresholdRev = parseFloat(document.getElementById('elasticityThresholdRev').value);
        const elasticityFactorRev = parseFloat(document.getElementById('elasticityFactorRev').value);
        let effectiveRevenuePerUnit = revenuePerUnit;
        if (revenueUnits > elasticityThresholdRev) {
          effectiveRevenuePerUnit = Math.max(revenuePerUnit - elasticityFactorRev * (revenueUnits - elasticityThresholdRev), 0);
        }
        const totalRevenue = revenueUnits * effectiveRevenuePerUnit;
        const totalCost = overallFixedCost + modifiedComputeCost + storageCost + networkCost + licenseCost;
        const profit = totalRevenue - totalCost;
        sensitivityData.push(profit);
        sensitivityLabels.push(testRate.toFixed(2) + "%");
      }

      const sensitivityResultsDiv = document.getElementById('sensitivityResults');
      sensitivityResultsDiv.style.display = 'block';
      let tableHTML = '<h5>Sensitivity Analysis: Profit vs. Compute Tier 1 Discount Rate</h5><table class="table table-sm table-bordered"><thead><tr><th>Tier 1 Discount Rate</th><th>Profit ($)</th></tr></thead><tbody>';
      for (let i = 0; i < sensitivityLabels.length; i++) {
        tableHTML += `<tr><td>${sensitivityLabels[i]}</td><td>${sensitivityData[i].toFixed(2)}</td></tr>`;
      }
      tableHTML += '</tbody></table>';
      sensitivityResultsDiv.innerHTML = tableHTML;
    });

    // ---------- Export Report as PDF ----------
    async function exportReport() {
      const deterministicHTML = document.getElementById('deterministicResults').innerText;
      const simulationHTML = document.getElementById('simulationResults').innerText;
      const sensitivityHTML = document.getElementById('sensitivityResults').innerText;
      const forecastCanvas = document.getElementById('forecastChart');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("FinOps Analysis Report", 10, 15);
      doc.setFontSize(12);
      doc.text("Deterministic Metrics:", 10, 25);
      doc.text(deterministicHTML, 10, 35);

      let yPos = 60;
      doc.text("Monte Carlo Simulation Summary:", 10, yPos);
      yPos += 10;
      doc.text(simulationHTML, 10, yPos);

      yPos += 20;
      doc.text("Sensitivity Analysis:", 10, yPos);
      yPos += 10;
      doc.text(sensitivityHTML, 10, yPos);

      if (forecastCanvas && forecastCanvas.style.display !== 'none') {
        const imgData = forecastCanvas.toDataURL("image/png");
        yPos += 30;
        doc.text("12‑Month Forecast Chart:", 10, yPos);
        yPos += 10;
        doc.addImage(imgData, 'PNG', 10, yPos, 180, 80);
      }

      doc.save("FinOps_Report.pdf");
    }
    document.getElementById('exportReportBtn').addEventListener('click', exportReport);
  </script>
</body>
</html>
